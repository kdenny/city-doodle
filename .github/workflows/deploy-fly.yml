name: Deploy to Fly.io

# Deploys API and Worker to Fly.io
#
# Required secrets:
#   FLY_API_TOKEN - Fly.io API token for deployment
#
# Required Fly.io secrets (set via `flyctl secrets set` before first deploy):
#   API:
#     DATABASE_URL      - Postgres connection string (asyncpg format)
#     DATABASE_URL_SYNC - Postgres connection string (psycopg2 format, for Alembic)
#   Worker:
#     DATABASE_URL      - Postgres connection string

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_api:
        description: 'Deploy API'
        required: false
        default: true
        type: boolean
      deploy_worker:
        description: 'Deploy Worker'
        required: false
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      worker: ${{ steps.filter.outputs.worker }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
            worker:
              - 'apps/worker/**'

  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_api == 'true' ||
      github.event_name == 'push' && needs.detect-changes.outputs.api == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-action/setup-flyctl@master

      - name: Deploy API to Fly.io
        working-directory: apps/api
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  deploy-worker:
    name: Deploy Worker
    runs-on: ubuntu-latest
    # Deploy worker AFTER API to ensure migrations have run
    needs: [detect-changes, deploy-api]
    # Run if API deployed successfully OR was skipped (worker-only changes)
    if: |
      always() &&
      (needs.deploy-api.result == 'success' || needs.deploy-api.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_worker == 'true' ||
        github.event_name == 'push' && needs.detect-changes.outputs.worker == 'true'
      )
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-action/setup-flyctl@master

      - name: Deploy Worker to Fly.io
        working-directory: apps/worker
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
