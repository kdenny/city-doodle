# Validate alembic migration chain on PRs that touch migration files.
# Catches duplicate revisions, broken down_revision links, and multiple heads
# before they reach main.
name: Validate Migrations

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/api/alembic/**'
      - 'apps/api/src/city_api/models/**'
      - '.github/workflows/migrations.yml'

jobs:
  validate:
    name: Validate Migration Chain
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install alembic sqlalchemy psycopg2-binary python-dotenv

      - name: Check for single head
        run: |
          heads=$(alembic heads 2>&1)
          head_count=$(echo "$heads" | grep -c "(head)")
          echo "Alembic heads output:"
          echo "$heads"
          echo ""
          if [ "$head_count" -gt 1 ]; then
            echo "::error::Migration chain has $head_count heads — expected exactly 1. Multiple heads indicate a branching conflict (e.g. duplicate revision IDs)."
            exit 1
          elif [ "$head_count" -eq 0 ]; then
            echo "::error::No migration head found. Check that migration files are valid."
            exit 1
          fi
          echo "Single head found."

      - name: Verify history is linear
        run: |
          history=$(alembic history 2>&1)
          echo "Migration history:"
          echo "$history"
          echo ""
          # Check for alembic warnings (e.g. "Revision X is present more than once")
          if echo "$history" | grep -qi "present more than once\|UserWarning"; then
            echo "::error::Duplicate revision IDs detected in migration chain."
            exit 1
          fi
          echo "Migration history is clean."

      - name: Dry-run upgrade (offline)
        env:
          DATABASE_URL: "postgresql://localhost/fake_dry_run"
        run: |
          # Generate the full upgrade SQL without connecting to a database.
          # This catches import errors, bad op calls, and syntax issues.
          # Data migrations (op.get_bind().execute) won't run offline, so
          # this step warns instead of failing — the chain checks above are
          # the hard gate.
          sql=$(alembic upgrade head --sql 2>&1)
          status=$?
          if [ $status -ne 0 ]; then
            echo "::warning::Offline SQL generation failed (likely a data migration). Review manually."
            echo "$sql" | tail -5
          else
            echo "Offline upgrade SQL generated successfully ($(echo "$sql" | wc -l) lines)."
          fi
