# Transit System Architecture

This document describes how the transit system (subway and rail) works in City Doodle.

## Overview

The transit system supports two types of transit:
- **Subway**: Underground rail with stations marked by circles
- **Rail**: Surface rail with visible tracks and station buildings

## Data Model (CITY-164)

### Stations

```typescript
interface TransitStation {
  id: string;
  worldId: string;
  districtId: string;  // Must be placed within a district
  stationType: "subway" | "rail";
  name: string;
  position: { x: number; y: number };
  isTerminus: boolean;
}
```

Stations require placement inside a district boundary for validation.

### Lines

```typescript
interface TransitLine {
  id: string;
  worldId: string;
  lineType: "subway" | "rail";
  name: string;       // e.g., "Red Line"
  color: string;      // Hex color
  isAutoGenerated: boolean;
  segments: TransitLineSegment[];
}
```

### Line Segments

```typescript
interface TransitLineSegment {
  id: string;
  lineId: string;
  fromStationId: string;
  toStationId: string;
  geometry: Point[];   // Intermediate points for curved routes
  isUnderground: boolean;
  orderInLine: number;
}
```

## Station Placement (CITY-165, CITY-166)

### Subway Stations (CITY-165)
- Placed via placement palette "Subway" seed
- Rendered as circles with station name label
- Underground lines drawn between stations

### Rail Stations (CITY-166)
- Placed via placement palette "Rail Station" seed
- Rendered with station building icon
- Visible surface tracks

### Validation
Stations must be placed inside a district:
```typescript
function isPointInDistrict(point: Point, district: District): boolean
```

## Line Drawing (CITY-167)

Manual line drawing workflow:
1. Select transit line drawing mode
2. Click first station to start line
3. Click subsequent stations to add segments
4. System creates line and segments automatically

The `TransitLineDrawingProvider` manages drawing state and creates segments via API.

## Line Editing (CITY-198)

Lines can be edited after creation:
- Rename line
- Change color
- Delete line (cascades to segments)

## Station Management (CITY-197)

Stations can be deleted via inspector panel:
- Select station on map
- Click delete in inspector
- Connected line segments are also removed

## Visibility Toggle (CITY-196)

Transit layers can be toggled:
- Show/hide subway tunnels
- Show/hide rail tracks
- Show/hide station labels

## Persistence

Transit data is stored in three tables:
- `transit_stations`
- `transit_lines`
- `transit_line_segments`

API endpoints:
- `GET /worlds/{id}/transit` - Full network
- `POST /worlds/{id}/transit/stations` - Create station
- `POST /worlds/{id}/transit/lines` - Create line
- `POST /transit/lines/{id}/segments` - Add segment

## Rendering

### Transit View Panel (CITY-194, CITY-195)

The transit view shows:
- List of all transit lines with colors
- Line details and stations
- Click to highlight on map

### Map Layers

Transit is rendered in separate layers:
- `SubwayLayer`: Underground lines and stations
- `TransitLayer`: Surface rail tracks and stations

## Auto-Connection (Future)

When placing a new station:
- Check if near existing line terminus
- Offer to extend line automatically
- Consider straight-line vs. realistic routing

## Related Tickets

- CITY-164: Database schema
- CITY-165: Subway station placement
- CITY-166: Rail station placement
- CITY-167: Line drawing
- CITY-194: Transit panel data
- CITY-195: Line highlighting
- CITY-196: Layer toggle
- CITY-197: Station deletion
- CITY-198: Line editing
