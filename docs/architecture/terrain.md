# Terrain Generation Architecture

This document describes how terrain and natural features are generated in City Doodle.

## Overview

Terrain is procedurally generated from a world seed, producing:
- Water features (ocean, lakes)
- Coastlines
- Rivers
- Contour lines
- Beaches

## Seeded Randomness (CITY-172, CITY-206)

All procedural generation uses seeded randomness:

```typescript
function seededRandom(seed: number): () => number
```

- Each world has a unique `seed` stored in the database
- Same seed produces identical terrain
- Shuffle button regenerates with new seed

**Important**: The world seed must be passed to `MapCanvas` component. Otherwise, a default seed is used and all worlds look identical.

## Water Features

### Ocean (Primary Water)

The ocean is generated as the largest water body, typically on one side of the map. Uses Perlin noise for natural coastline shapes.

### Lakes (CITY-180)

Lakes are classified by type:

| Type | Description | Shape |
|------|-------------|-------|
| glacial | Irregular shores | Complex polygon |
| crater | Volcanic caldera | Circular |
| oxbow | River meander cutoff | Crescent |
| reservoir | Man-made with dam | One straight edge |
| rift | Deep, narrow | Elongated |
| pond | Small | Simple shape |
| kettle | Glacial ice block | Small, circular |

Classification based on shape metrics:
- `circularity`: 0-1, how round
- `elongation`: Ratio of long/short axis

### Bays (CITY-177)

Bays are coastal indentations inspired by real cities:
- San Francisco Bay style (large, central)
- Boston Harbor style (complex, protected)
- Sydney Harbour style (branching inlets)

Generated by adding negative Perlin noise to coastline.

### Barrier Islands (CITY-178)

Coastal barrier islands:
- Generated parallel to coastline
- Create protected lagoons
- Affect district placement

## Beaches (CITY-176)

Beaches generated along coastlines:

```typescript
interface BeachFeature {
  id: string;
  beachType: "ocean" | "bay" | "lake" | "river";
  polygon: Polygon;
  width?: number;
  name?: string;
}
```

Beach width varies based on:
- Terrain slope (gentle = wide beach)
- World settings (`beach_width_multiplier`)
- Can be disabled via `beach_enabled` setting

## Rivers

Rivers flow from high elevation to water:
1. Start at high elevation point
2. Follow gradient descent
3. Terminate at ocean/lake
4. Width increases toward mouth

## Contour Lines

Elevation contours for topographic display:
- Generated from elevation grid
- Styled by elevation interval
- Hidden underwater

## Terrain Data Structure

```typescript
interface TerrainData {
  water: WaterFeature[];
  coastlines: CoastlineFeature[];
  rivers: RiverFeature[];
  contours: ContourLine[];
  beaches: BeachFeature[];
}
```

## Terrain Context

The `TerrainContext` provides:
- `terrainData`: Current terrain features
- `getWaterFeatures()`: For collision detection
- `elevation(x, y)`: Get elevation at point

Used by district generation to:
- Clip districts against water
- Validate placement locations
- Generate appropriate street grids

## Grid Layer (CITY-205)

The grid layer shows:
- Tile boundaries
- Coordinate markers

**Note**: Tile center markers were removed (CITY-205) as they were debugging artifacts.

## Name Generation (CITY-188)

Natural features get auto-generated names:
- Lakes: Based on type and size (e.g., "Lake Crystal", "Crater Lake")
- Rivers: Classic river names
- Parks: Local park naming styles
- Districts: Based on type and personality

## Related Tickets

- CITY-172: Seeded randomness
- CITY-176: Beach generation
- CITY-177: Bay generation
- CITY-178: Barrier islands
- CITY-180: Lake variety
- CITY-188: Name generation
- CITY-205: Grid cleanup
- CITY-206: Seed propagation fix
