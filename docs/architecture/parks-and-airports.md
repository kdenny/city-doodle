# Park and Airport Generation Architecture

This document describes how parks and airports are generated as polygon-based districts with internal features, street connections, and context-aware naming.

## Overview

Parks and airports are specialized district types that:
- Generate organic polygon shapes (not rectangular grids)
- Have internal features instead of street grids (trails/ponds for parks, runways/taxiways for airports)
- Connect to the surrounding street network via perimeter or access roads
- Use context-aware naming based on the world name, adjacent districts, and nearby water features

## Park Generation (CITY-378)

### Placement Flow

1. **Seed Selection**: User picks a park seed from the palette (`park_pocket`, `park_neighborhood`, `park_community`, `park_regional`, `park_city`)
2. **Size Determination**: Park size comes from `PARK_SIZE_CONFIG` based on the seed tier
3. **Routing**: `EditorShell.handlePlaceSeed()` routes park seeds through `addDistrict()` (not `addSeed()`)
4. **Polygon Generation**: `districtGenerator.generateDistrictGeometry()` creates an organic polygon (always organic shape, no street grid)
5. **Park Features**: `parkGenerator.generateParkFeaturesForDistrict()` generates internal trails, ponds, perimeter roads, and connection roads
6. **Persistence**: District + roads + ponds are saved to the API

### Park Size Tiers

| Tier | Seed ID | Radius (world units) | Real-world equivalent |
|------|---------|---------------------|----------------------|
| Pocket | `park_pocket` | 0.5 | Small neighborhood garden |
| Neighborhood | `park_neighborhood` | 2.0 | City block park |
| Community | `park_community` | 5.0 | Several blocks |
| Regional | `park_regional` | 10.0 | Large park (like Prospect Park) |
| City | `park_city` | 20.0 | Major park (like Central Park) |

Size config is exported from `apps/web/src/components/palette/index.ts` as `PARK_SIZE_CONFIG`.

### Internal Features

Generated by `parkGenerator.generateParkFeaturesForDistrict()`:

- **Trails**: Internal walking paths rendered as `trail` road class
- **Ponds**: Small water bodies rendered as blue polygons within the park boundary
- **Perimeter Roads**: `collector` or `local` class roads along the 4 cardinal sides of the park (e.g., "Central Park North Drive")
- **Connection Roads**: Access points connecting perimeter roads to the nearest existing streets

### Pond Storage

Park ponds are stored in the `District.ponds` field (array of `Polygon` objects). For API persistence, ponds are serialized into the `street_grid` JSONB column alongside road data and restored via `fromApiDistrict()`.

### Key Files

- `apps/web/src/components/canvas/layers/parkGenerator.ts` — Trail, pond, perimeter road, and connection road generation
- `apps/web/src/components/canvas/layers/FeaturesLayer.ts` — Pond rendering (water-colored polygons)
- `apps/web/src/components/palette/index.ts` — `PARK_SIZE_CONFIG` export

## Airport Generation (CITY-379)

### Placement Flow

1. **Seed Selection**: User picks the airport seed from the palette (category: `airport`)
2. **Size**: Fixed at `AIRPORT_SIZE_WORLD_UNITS` (30 world units diameter, ~3km x 2km)
3. **Routing**: `EditorShell.handlePlaceSeed()` routes airport seeds through `addDistrict()` with airport-specific sizing
4. **Polygon Generation**: `districtGenerator.generateDistrictGeometry()` creates a large organic polygon (1.5x scale factor)
5. **Airport Features**: `airportGenerator.generateAirportFeaturesForDistrict()` generates runways, taxiways, and access roads
6. **Persistence**: District + roads saved to the API

### Internal Features

Generated by `airportGenerator.generateAirportFeaturesForDistrict()`:

- **Runways**: 1-3 parallel runways rendered as `highway` class roads. Realistic designations (e.g., "Runway 27L/09R"). Slight rotation from horizontal (±8.5 degrees) to simulate prevailing wind orientation.
- **Taxiways**: `collector` class roads connecting runways to the terminal area (center of polygon). Named alphabetically (Taxiway A, B, C...).
- **Access Roads**: `arterial` class roads connecting the airport perimeter to the nearest existing roads, preferring arterials and highways.

### Runway Generation Details

```
Number of runways: 1-3 (random)
Runway length: 70-85% of the longest polygon dimension
Runway spacing: 25% of the shortest dimension
Taxiways per runway: 2-3
```

Runway designations follow real aviation conventions: heading divided by 10, with L/C/R suffixes for parallel runways.

### Key Files

- `apps/web/src/components/canvas/layers/airportGenerator.ts` — Runway, taxiway, and access road generation
- `apps/web/src/components/palette/types.ts` — Airport seed definition (category: `airport`)
- `apps/web/src/components/canvas/layers/SeedsLayer.ts` — Airport category colors (blue-gray)

## Context-Aware Naming (CITY-380)

### Overview

Parks and airports use context-aware naming that references the world name, adjacent districts, and nearby water features instead of generic prefix+suffix combinations.

### Airport Naming

`generateAirportName()` uses the world/city name for realistic patterns:

| Pattern | Probability | Example |
|---------|------------|---------|
| `{worldName} International Airport` | 45% | "Springfield International Airport" |
| `{worldName} Regional Airport` | 20% | "Springfield Regional Airport" |
| `{worldName} Municipal Airport` | 15% | "Springfield Municipal Airport" |
| `{worldName} Int'l Airport` | 20% (of world-name branch) | "Springfield Int'l Airport" |
| Notable person + suffix (fallback) | 20% overall | "Kennedy International Airport" |

When no world name is available, falls back to a notable-person pattern.

### Park Naming

`generateContextAwareParkName()` checks nearby features:

1. **Water reference** (40% when available): Uses the name of a nearby lake/river. E.g., "Crystal Park" near Crystal Lake, or "Lakeside Park" near any water.
2. **District reference** (30% when available): Uses the first word of an adjacent district name. E.g., "Maple Green" near "Maple Heights" district.
3. **Standard fallback**: Delegates to the existing `generateParkName()` with its 4 pattern types (nature word, memorial/founder, geographic, tree/plant).

### Naming Context

The `NamingContext` interface threads nearby feature information from `FeaturesContext` through `DistrictGenerationConfig` to the name generator:

```typescript
interface NamingContext {
  worldName?: string;              // From world?.name
  adjacentDistrictNames?: string[]; // Districts within search radius
  nearbyWaterNames?: string[];      // Lakes/rivers within search radius
  adjacentDistrictTypes?: NearbyContext[];
}
```

**Search radius**: Computed from the district size (`config.size * 0.8`, default 50 world units). Uses centroid distance for districts and polygon/line proximity for water features.

### Key Files

- `apps/web/src/utils/nameGenerator.ts` — `generateAirportName()`, `generateContextAwareParkName()`, `NamingContext` interface
- `apps/web/src/components/canvas/layers/districtGenerator.ts` — `namingContext` in config, threaded to `getDistrictName()`
- `apps/web/src/components/canvas/FeaturesContext.tsx` — Context computation (adjacent districts, water features, rivers)

## Common Architecture

### No Street Grids

Both parks and airports skip street grid generation in `districtGenerator.ts`:

```typescript
if (districtType !== "park" && districtType !== "airport") {
  // Generate street grid...
}
```

### Organic Polygon Shape

Both types always use `generateOrganicPolygon()` regardless of the `grid_organic` slider:

```typescript
if (districtType === "park" || districtType === "airport") {
  // Always organic shapes
  polygonPoints = generateOrganicPolygon(...);
}
```

Airports use a 1.5x scale factor for larger polygons.

### Seeded Randomness

All generation uses seeded RNG (`SeededRandom` class with LCG algorithm) derived from district centroid position:

```
seed = floor(centroidX * 1000 + centroidY * 7919)
```

Same position + settings = same features.

## Related Tickets

- CITY-378: Integrate park generator into placement flow with perimeter roads
- CITY-379: Create airport generator with polygon shapes, internal features, and access roads
- CITY-380: Context-aware name generation for parks and airports
- CITY-381: Documentation for park and airport generation systems
- CITY-345: Auto-generate POIs matching district type on placement
